#!/usr/bin/env ruby

$LOAD_PATH.push File.join(File.dirname(__FILE__), "/../lib")
require 'hpc'
require 'cpc'
require 'digest/sha1'
require 'rss'
require 'time'

feed_path = "/var/www/vhosts/brianlbridges.com/httpdocs/grumpyrainbow.com/feeds/"

@obj = case ARGV[0]

       when "HPC" then HPC.new
       when "CPC" then CPC.new
       end

discussion_hash = @obj.get_discussions

discussion_hash.keys.each do |key|

  discussion_id = key.split('=').last

  title = @obj.get_discussion_title(discussion_id)

  if ARGV[0] == "HPC"

    item_to_write = nil

    rss = RSS::Maker.make("2.0") do |maker|
      maker.channel.author = "NOAA"
      maker.channel.updated = Time.now.rfc822
      maker.channel.about = "http://www.grumpyrainbow.com/feeds/#{ARGV[0].downcase}/#{discussion_id}"
      maker.channel.title = "#{ARGV[0]} - #{title}"
      maker.channel.link = key
      maker.channel.description = "#{ARGV[0]} - #{title}"

      maker.items.new_item do |item|
        item.title = "#{ARGV[0]} - #{title}"
        item.updated = Time.now.rfc822
        item.description = discussion_hash[key]
        item_to_write = item.description
      end
    end

    item_to_read = nil

    open("#{feed_path}#{ARGV[0].downcase}/#{discussion_id}.rss") do |rss|
      feed = RSS::Parser.parse(rss)
      feed.items.each { |item| item_to_read = item.description }
    end

    puts "item_to_read"
    puts item_to_read

    puts "item_to_write"
    puts item_to_write

    if item_to_read != item_to_write
      file = File.open("#{feed_path}#{ARGV[0].downcase}/#{discussion_id}.rss", "w") do |f|
        f.write(rss)
        f.close
        puts "wrote to #{feed_path}#{ARGV[0].downcase}/#{discussion_id}.rss"
      end
    end
  end
end
puts "script finished"
